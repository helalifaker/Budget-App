/**
 * React Query hooks for Integration Management
 *
 * Provides hooks for:
 * - Odoo integration (financial actuals)
 * - Skolengo integration (enrollment data)
 * - AEFE integration (position data)
 * - Integration settings and logs
 */

import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import {
  aefeIntegration,
  downloadFile,
  integrationLogs,
  integrationSettings,
  odooIntegration,
  skolengoIntegration,
  type AEFEImportResponse,
  type AEFEPositionListResponse,
  type IntegrationLog,
  type IntegrationSettings,
  type OdooConnectionRequest,
  type OdooConnectionResponse,
  type OdooImportActualsRequest,
  type OdooImportActualsResponse,
  type OdooSyncRequest,
  type SkolengoComparisonResponse,
  type SkolengoImportResponse,
} from '@/services/integrations';

// ============================================================================
// Odoo Hooks
// ============================================================================

export function useTestOdooConnection() {
  return useMutation<OdooConnectionResponse, Error, OdooConnectionRequest>({
    mutationFn: (request) => odooIntegration.testConnection(request),
    onSuccess: (data) => {
      if (data.success) {
        toast.success('Odoo Connection Successful', {
          description: data.message,
        });
      } else {
        toast.error('Odoo Connection Failed', {
          description: data.message,
        });
      }
    },
    onError: (error) => {
      toast.error('Connection Error', {
        description: error.message,
      });
    },
  });
}

export function useImportOdooActuals() {
  const queryClient = useQueryClient();

  return useMutation<OdooImportActualsResponse, Error, OdooImportActualsRequest>({
    mutationFn: (request) => odooIntegration.importActuals(request),
    onSuccess: (data) => {
      toast.success('Import Successful', {
        description: `Imported ${data.records_imported} actual records for period ${data.message}`,
      });
      queryClient.invalidateQueries({ queryKey: ['integration-logs', 'odoo'] });
    },
    onError: (error) => {
      toast.error('Import Failed', {
        description: error.message,
      });
    },
  });
}

export function useSyncOdooActuals() {
  const queryClient = useQueryClient();

  return useMutation<{ success: boolean; results: Record<string, unknown> }, Error, OdooSyncRequest>({
    mutationFn: (request) => odooIntegration.syncActuals(request),
    onSuccess: () => {
      toast.success('Sync Completed', {
        description: 'All periods have been synced from Odoo',
      });
      queryClient.invalidateQueries({ queryKey: ['integration-logs', 'odoo'] });
    },
    onError: (error) => {
      toast.error('Sync Failed', {
        description: error.message,
      });
    },
  });
}

// ============================================================================
// Skolengo Hooks
// ============================================================================

export function useExportSkolengoEnrollment() {
  return useMutation<Blob, Error, string>({
    mutationFn: (versionId) => skolengoIntegration.exportEnrollment(versionId),
    onSuccess: (blob) => {
      downloadFile(blob, `enrollment_export_${new Date().toISOString()}.csv`);
      toast.success('Export Successful', {
        description: 'Enrollment data has been exported to CSV',
      });
    },
    onError: (error) => {
      toast.error('Export Failed', {
        description: error.message,
      });
    },
  });
}

export function useImportSkolengoEnrollment() {
  const queryClient = useQueryClient();

  return useMutation<SkolengoImportResponse, Error, { versionId: string; file: File }>({
    mutationFn: ({ versionId, file }) => skolengoIntegration.importEnrollment(versionId, file),
    onSuccess: (data) => {
      toast.success('Import Successful', {
        description: `Imported ${data.records_imported} enrollment records`,
      });
      queryClient.invalidateQueries({ queryKey: ['integration-logs', 'skolengo'] });
      queryClient.invalidateQueries({ queryKey: ['skolengo-comparison'] });
    },
    onError: (error) => {
      toast.error('Import Failed', {
        description: error.message,
      });
    },
  });
}

export function useSyncSkolengoEnrollment() {
  const queryClient = useQueryClient();

  return useMutation<SkolengoImportResponse, Error, string>({
    mutationFn: (versionId) => skolengoIntegration.syncEnrollment(versionId),
    onSuccess: (data) => {
      toast.success('Sync Successful', {
        description: `Synced ${data.records_imported} enrollment records`,
      });
      queryClient.invalidateQueries({ queryKey: ['integration-logs', 'skolengo'] });
      queryClient.invalidateQueries({ queryKey: ['skolengo-comparison'] });
    },
    onError: (error) => {
      toast.error('Sync Failed', {
        description: error.message,
      });
    },
  });
}

export function useSkolengoComparison(versionId: string) {
  return useQuery<SkolengoComparisonResponse, Error>({
    queryKey: ['skolengo-comparison', versionId],
    queryFn: () => skolengoIntegration.compareEnrollments(versionId),
    enabled: !!versionId,
  });
}

// ============================================================================
// AEFE Hooks
// ============================================================================

export function useImportAEFEPositions() {
  const queryClient = useQueryClient();

  return useMutation<AEFEImportResponse, Error, File>({
    mutationFn: (file) => aefeIntegration.importPositions(file),
    onSuccess: (data) => {
      toast.success('Import Successful', {
        description: `Imported ${data.records_imported} AEFE positions`,
      });
      queryClient.invalidateQueries({ queryKey: ['integration-logs', 'aefe'] });
      queryClient.invalidateQueries({ queryKey: ['aefe-positions'] });
      queryClient.invalidateQueries({ queryKey: ['aefe-summary'] });
    },
    onError: (error) => {
      toast.error('Import Failed', {
        description: error.message,
      });
    },
  });
}

export function useAEFEPositions() {
  return useQuery<unknown[], Error>({
    queryKey: ['aefe-positions'],
    queryFn: () => aefeIntegration.getPositions(),
  });
}

export function useAEFEPositionSummary() {
  return useQuery<AEFEPositionListResponse, Error>({
    queryKey: ['aefe-summary'],
    queryFn: () => aefeIntegration.getPositionSummary(),
  });
}

export function useDownloadAEFETemplate() {
  return useMutation<Blob, Error, void>({
    mutationFn: () => aefeIntegration.downloadTemplate(),
    onSuccess: (blob) => {
      downloadFile(blob, `aefe_positions_template_${new Date().toISOString()}.xlsx`);
      toast.success('Template Downloaded', {
        description: 'AEFE position template has been downloaded',
      });
    },
    onError: (error) => {
      toast.error('Download Failed', {
        description: error.message,
      });
    },
  });
}

// ============================================================================
// Integration Settings Hooks
// ============================================================================

export function useIntegrationSettings(integrationType: string) {
  return useQuery<IntegrationSettings, Error>({
    queryKey: ['integration-settings', integrationType],
    queryFn: () => integrationSettings.getSettings(integrationType),
    enabled: !!integrationType,
  });
}

export function useSaveIntegrationSettings() {
  const queryClient = useQueryClient();

  return useMutation<
    IntegrationSettings,
    Error,
    {
      integrationType: string;
      config: Record<string, unknown>;
      autoSyncEnabled?: boolean;
      autoSyncIntervalMinutes?: number | null;
    }
  >({
    mutationFn: ({ integrationType, config, autoSyncEnabled, autoSyncIntervalMinutes }) =>
      integrationSettings.saveSettings(
        integrationType,
        config,
        autoSyncEnabled,
        autoSyncIntervalMinutes
      ),
    onSuccess: (_, variables) => {
      toast.success('Settings Saved', {
        description: `${variables.integrationType} integration settings have been saved`,
      });
      queryClient.invalidateQueries({
        queryKey: ['integration-settings', variables.integrationType],
      });
    },
    onError: (error) => {
      toast.error('Save Failed', {
        description: error.message,
      });
    },
  });
}

export function useUpdateIntegrationSettings() {
  const queryClient = useQueryClient();

  return useMutation<
    IntegrationSettings,
    Error,
    { integrationType: string; updates: Partial<IntegrationSettings> }
  >({
    mutationFn: ({ integrationType, updates }) =>
      integrationSettings.updateSettings(integrationType, updates),
    onSuccess: (_, variables) => {
      toast.success('Settings Updated', {
        description: `${variables.integrationType} settings have been updated`,
      });
      queryClient.invalidateQueries({
        queryKey: ['integration-settings', variables.integrationType],
      });
    },
    onError: (error) => {
      toast.error('Update Failed', {
        description: error.message,
      });
    },
  });
}

// ============================================================================
// Integration Logs Hooks
// ============================================================================

export function useIntegrationLogs(
  integrationType?: string,
  status?: string,
  limit = 50,
  offset = 0
) {
  return useQuery<
    {
      logs: IntegrationLog[];
      total_count: number;
      page: number;
      page_size: number;
    },
    Error
  >({
    queryKey: ['integration-logs', integrationType, status, limit, offset],
    queryFn: () => integrationLogs.getLogs(integrationType, status, limit, offset),
  });
}

export function useIntegrationLog(logId: string) {
  return useQuery<IntegrationLog, Error>({
    queryKey: ['integration-log', logId],
    queryFn: () => integrationLogs.getLog(logId),
    enabled: !!logId,
  });
}
